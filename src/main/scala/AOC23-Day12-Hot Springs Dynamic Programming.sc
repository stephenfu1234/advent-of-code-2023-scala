import scala.collection.mutable

val sampleInput = "???.### 1,1,3\n.??..??...?##. 1,1,3\n?#?#?#?#?#?#?#? 1,3,1,6\n????.#...#... 4,1,1\n????.######..#####. 1,6,5\n?###???????? 3,2,1"
val puzzleInput = ".?????...? 1,1,1\n#????????.#?#?????? 2,1,1,5,1\n???##?###????? 1,2,3,4\n?#?????##????#?? 1,9\n?.?.??#?...????? 1,2,1\n.#.#???..??#???#?? 1,1,1,1,1,4\n?#??#??#..#?#???. 1,4,1,1,2\n??######???.??.. 7,1,1\n.?#???#?#?#??.?.?.#? 2,7,1,1,1\n.?#.???.???.#??? 2,1,1,3,4\n?????????#?. 2,1,3\n??.?.?.#??##?#?#?. 1,9\n?....?.?#?#???? 1,1,7\n?.??.????#?#??##??#. 1,9,2\n?.??#...#? 1,1,1\n?###??????#??#? 7,5\n??????##????# 1,7,2\n??????.????.. 1,2\n??##??#??#.. 5,2\n#????#?#???????#??#. 8,8\n???#..????###??? 2,2,3,2\n?##?#?#?????#?.#??? 2,3,1,1,4\n??#?..?#???? 3,3,1\n??#.?#??.?#????? 1,4,2,1\n???.?#????? 1,5\n.?#.???##??? 2,6\n...#.?#?##. 1,1,2\n????.?????? 1,2,1\n?#?????????# 2,2,1,2\n??##??????. 5,1,1\n???..??#???#????## 1,1,1,9\n??#??##??# 1,3,1\n??#????#??.?????##. 9,3\n??.?#??#??#.???#?.?? 2,2,1,1,4,1\n?#??#?#??#??#????. 11,1,1,1\n.#...??###? 1,5\n???#?#?#??????? 1,1,1,6,1\n.???#.??##?..#??# 3,4,2,1\n???#?.???# 1,1,1\n???#??###?#?#???? 1,12,1\n??.#?????? 2,2,2\n#?#??..#?# 5,1,1\n#?..?????##?#.???#?? 2,2,5,6\n????#?.??##?.??#?? 6,5,1,1\n.??.#?##????. 1,6\n#??#?####??#?.?? 1,1,8,1\n?#.??#?#?#??#???? 1,1,9,1\n.???????#?. 4,3\n.?.?#???#?#?#??#.? 1,10,2\n????#??#??#..?. 1,1,1,2,1\n.??#??#????.??? 7,2\n??#?#?????.?? 3,2,1,1\n???#.??#????#??# 2,3,4\n??.??#?.#??#??#?? 1,1,2,4,1\n????#.????.?#???? 5,3,1,1,1\n?????##??????? 1,1,9\n?????.???#??.? 3,6\n.?????##????. 5,1\n??????????. 3,1,2\n?####.??#???.? 4,5\n?.#??.??????.?#??#? 2,5,5\n?..#?????????? 1,1,5\n???????#.???? 4,1\n?.??.?????#????. 2,2,1,1,2\n????#..?????#.?? 3,5,1\n???????????#???# 7,5,1\n.???#..???? 1,1,2\n??.?.?.???#? 2,1,2\n??##???#?????. 3,4\n??.????..??###??? 1,4\n.??#????#?# 4,3\n???.????#.?#?##???# 1,1,1,1,1,8\n??????#?.?.??? 3,2\n?.???..????? 2,3\n?..??#??????? 1,2,1,1\n?.#???.?#??? 1,1,3\n??????#???.??????? 7,1,1,1\n???#?#???????#?. 4,3,2,2\n??###?.??#?#? 3,5\n?#???.??????????# 5,1,1,1,4\n???#.????#???.# 1,1,4,2,1\n???.#???#?? 2,7\n?#.?#?###??#?. 1,10\n.?..????#?#?? 1,2,2,1\n.??.?????# 1,3,1\n???#??.????#??? 6,1,3,1\n??#?#?#???# 3,1,3\n?????????????????? 3,4\n#????#????##?????? 13,2\n????#??.#?#?##?#??? 1,2,8,2\n.??#?##??.?#?????#?? 5,9\n?##..#???? 3,1\n?##.##???#??.##???# 2,3,4,6\n#?????????#? 1,1,3,2\n???#?????????? 2,2,1,1\n??#??##??#?.? 1,5,1,1\n?#??.??##???????.?? 1,1,9,1,1\n??#?##??##?.??#??? 10,1,2,1\n..??#..?#?.? 1,2\n??#?.?.????? 1,1,1,1\n#.?##??.?.? 1,2,1\n..?..??#????#..? 1,8\n.?#??.??????. 3,5\n??.????#???#????? 1,1,3,2,1\n??.#??..?? 1,3,2\n#?.#??????.?? 2,2,3,1\n????.???.? 3,1\n#???.??????# 1,2,1,2\n?.?.??.?#??.??? 1,1,1,1,3\n?.#????#.? 1,1,1\n.????#??.? 2,4,1\n???##??#?..#??#??? 5,1,4\n??#??##?.???#? 5,4\n??#??#???##????.? 3,3,6\n.?##??.#?..? 2,2\n?????#.?#?#???#??? 3,9\n.#.??#???? 1,3\n??????.??.? 5,1,1\n.??.???????????. 1,7\n??????##???#?##??.#? 2,13,2\n??#???????#?? 3,1,1,3\n?????.?#??? 2,3\n????.????????? 1,6\n#?#.??#?.#?? 1,1,2,1\n?#?????#?###?????# 4,7,2,1\n?????#???.?.? 3,1\n#?#?.#?##??. 3,6\n??#.????????? 1,1,3,1\n??????#????.?? 1,1,2,2\n??????#?.??##??? 1,3\n?.###???#???? 4,2,1\n??.????.??.#.#??#? 2,1,1,1,2,2\n??##.???##?##?.##?#? 3,2,5,4\n??.?????????#?? 1,2,5\n.##????????. 4,1\n??..?##.???? 1,2,2,1\n.?#?.????.#?##?... 2,2,1,3\n#?????.???#?#??? 1,1,1,7\n?#.#???.#??#???.???. 2,1,1,1,4,2\n??????????##???#??? 1,1,7\n???#?#???.##.. 3,2\n.??##?#.??#?. 6,1\n?##?.###?#?? 3,5\n????###?..???..? 1,6,3\n..#????#?#??? 1,3,2\n#?#????????# 4,1,4\n?#???????????#?? 2,3,1,3\n.#???#?..??#?????# 1,2,9\n??.?#.???. 1,1,1\n?#?#??.???.#? 1,2,2,1\n??##??#???#? 3,5\n?#???????. 3,1\n.#?????.??? 3,2\n.#?#?##??????#?? 1,4,6\n??.??.?##?.?? 1,1,3,1\n??##??.#.?.?# 4,1,1,2\n#???????#?? 1,1,4\n????#??.?#???? 1,4,1,3\n#?.?##???.? 1,3\n????#?????##?##???.? 8,6\n??.?#?.???.#??? 2,1,1,2\n??#??#.??.???. 2,1,3\n.?.?.??.?##### 1,1,5\n???#??.???#??#.?? 1,3,1,5,1\n..#????##??#?#?.? 1,10\n?#.????#??. 2,5\n#.????????#?#??#??? 1,1,7,2,1\n.?.?...?##?#?#?#?. 1,9\n???????????# 1,1,6\n??#???????#?..?? 9,1\n..?#?????? 1,3\n.?.???????? 2,4\n.??.#??.??? 2,1,1\n??#.????.? 1,1,1\n.#.??.????#???.???? 1,2,1,1,3,3\n??#??????.??? 5,1,2\n????????.??.?? 1,4,1,1\n???????#?? 3,3\n??#?????#???##. 2,1,2,2\n??#???????# 2,6\n?#?#??#??#.?.#?? 6,1,2\n##?##?#?.??#?? 8,1,1\n.?#??###?????#?? 8,3\n????#.#?#????? 3,6\n#??.????#??#.#??..?? 2,6,1,3,1\n??????.????? 2,1\n????.?????. 1,2,1\n???????#..#? 1,2,2,2\n????#??#?? 4,4\n???.?????##?##???? 1,14\n??#.???#.?#??.???? 2,2,1,1,1,1\n?.???#?.?. 1,5\n#.#?#.?##????? 1,3,5,1\n.?..?#???????#???#? 1,14\n.#?#??##??#?..??#?. 3,2,3,4\n.??#?#?.????.???.?# 6,1,1,1,1\n.?#.????.#.? 1,1,1,1\n?#?.??#??#?? 1,8\n??..?????? 1,5\n???.?????.? 2,4\n??#???.##?#?.??. 5,2,1,1\n??#???#?....???#?.?? 3,3,4,2\n?..???##..?.?. 1,5,1\n?#????????.?? 3,2,1\n?#??????.## 4,1,2\n.??.###.?#??. 1,3,3\n?.??????#?#??? 1,1,8\n?#.?.??????#?.???? 2,1,6,1\n.???????#?#???. 2,6\n???#????.?#??#??? 4,1,1,5\n??#???##???#? 7,2\n#??????.?? 2,2\n?.?#.?##???.?#?## 1,2,4\n.?#.??????#? 1,2,2,1\n#?#?#?#?##.??#?#.? 1,3,4,2,1,1\n???#?????#?#?? 1,6\n?????##?#?#?##??? 1,11\n#?????????##?.#??.? 1,2,1,6,2,1\n???#?.???????.?.. 1,3,2,2,1\n.??.#?????? 1,2,1\n??#?????#.? 6,1\n.????#??#??????. 12,1\n?.?...#??...?###??.? 2,4\n??.??.?##??..?? 2,1,5,1\n?#????.#??###? 2,1,6\n#.???#?.?#?#??.? 1,5,5\n#?#?????????#? 11,1\n#???#??#?#???.#..#? 12,1,1\n.??#?#?.????? 5,1\n?????.?????#????? 1,1,1,6\n.??#?.?????#???#??? 2,1,1,1,4\n?#???##????.#???? 7,1,4\n.?#?#??#.. 3,2\n..????????.#?????#.? 4,1,7,1\n??.????#.#??.?# 1,5,3,2\n?#??????.???##.? 3,3,2\n.#.?#???#???##??#?# 1,8,3,3\n??#.??#?..####?#?##? 1,1,4,4,5\n?#?????????#?# 5,5,1\n???????.?? 1,3,1\n???????..??.? 1,2,1,1\n.?##.#???? 2,2\n?#?.?#??#.#?? 1,5,2\n?.???.???##??????. 3,9\n?#.?????.?.???.??## 2,2,1,1,3,3\n???????#??.??#????. 5,2,3,3\n?????.???.? 4,1,1\n???????.?#?##?.? 1,1,5,1\n.??????.#??.??? 4,3,1\n??.?#??#?? 2,2\n?.#?.??#?.??#??.. 1,2,4,1,2\n??#?.??????? 2,1,1,1\n???????###????.#??. 3,9,2\n.#??.#??.###??#????# 3,3,7,1,1\n.??????.?? 2,2\n????#.#??#?##???? 1,1,11\n#???????##.? 1,1,4\n.?#?#???#?.???? 8,2\n?.??#?.#?.???..????? 1,3,2,1,5\n???#????#.#####?? 1,3,2,5,1\n??#?#?????? 6,2\n??.????#??#? 1,6,1\n#????.##?#. 2,2,4\n?#?#????????????? 9,1,1\n????##?#???? 6,4\n?????.?????? 5,1,1,1\n????????????????###. 1,8,7\n??.????????#??#?.?? 1,13,1\n????.#???.####? 2,1,5\n??#?#?????????#. 7,1,1\n??.#??##?? 1,1,5\n?.???#??#???#??#?# 1,1,9,1,1\n????#???#?#. 1,7\n???.???#???##.#?? 1,1,7,1\n??#.????#. 1,2,1\n.##.??#?#.? 2,4,1\n??#?.?.#.???? 3,1,1,2\n#???#??#?#?.???.? 10,1,1\n???..#??## 3,5\n.?????#??##???#. 6,2,1\n.???#???????????. 5,5\n?????#?.??? 1,2,2\n?#?#??..?.?#??.. 6,1,4\n???.?#.???? 1,2,1\n????.#??????##???.. 1,1,2,8\n.?????????.????##? 5,3,5\n?##???#????#?#??? 3,11\n?????##?.?#? 2,2,2\n?.????#????? 1,5,1\n???#.??#???.?#? 1,2,4,1,2\n##???#??..#?????? 3,1,1,5\n??????.??#.? 1,2,1,1\n?#????###??#?##? 2,9\n#.??#?.??####? 1,1,1,7\n?????#??.??#?????#? 5,9\n?#.??#.???##?? 1,3,4,1\n.#..??#???????.???? 1,4,1,2,1,1\n##?#.??###?## 2,1,7\n?#?#?#?.?? 3,1,2\n.??..???.???..#?? 1,1,1,1\n.?????????.?????#??? 2,3,3\n#.#?.???.????.???#. 1,2,1,4,1,2\n??????.?##?.. 4,3\n?.##?#??.#?###?###?# 6,9,1\n?.????.?.??????#??? 4,1,1,2,1\n.?.????.?#???. 1,5\n.?#????#??#.??#????? 3,4,5,1\n?#.#?##???#?????#? 1,9,1,1\n.???.??????#??#?. 2,7,2\n?????#??##?##?????? 2,1,9,1\n###?????????.?. 6,1,1,1\n??????????..#? 1,1,6,1\n????.??.?#.??.####?? 1,1,1,1,2,6\n?????#?#?##?#??# 1,13\n????#??#?????? 5,1,1,1\n..???##.#????#. 1,3,3,1\n??.?#?????? 2,5,1\n.??..??????#???#?? 1,2,3,3\n#?..?#?#??#??#?? 1,10\n?#??#?#?#???????? 7,5,2\n#?.??#??????.#.#? 1,3,2,1,2\n??#.???#.???????? 3,4,5\n..????..?##...? 2,3\n.??.??...? 2,1,1\n##...??#?.????## 2,4,5\n###.??#??#?#?.?# 3,8,1\n.??#??????#?#..??. 1,4,1,1,1,1\n????????#??##??? 2,1,1,6,1\n???.##?.??#. 3,3,1,1\n????????#????##??#?# 9,1,3,1,1\n??.??#??## 1,3,2\n????#?#??#?.???. 1,1,5,1,1\n??#???#.???? 2,1,1,1\n?????#???#??#??#?#.? 1,1,1,8,1\n??.?????.?.#??.?? 2,1\n??..?#???# 1,3,1\n.?##??????????? 7,1\n??????.??????.#.? 1,2,2,1,1\n.??????.??? 4,1\n?#????#.?.??? 2,1,1,3\n#.??#??#.##????. 1,3,2,2,3\n??.#?#?.?.??#?????. 1,1,1,1,1,4\n????#?????????#?.?? 1,3,7,1\n????????.?? 4,2,2\n.????????? 2,1\n#???#?#?.?????????? 1,5,2,1,3\n.?#??#??##?#. 2,7\n??#?.????#??###?.?? 1,5,4,2\n??.???.?##?? 1,3,4\n?.?????.???? 1,5,2\n??????#??? 3,1,1\n#..?#????????##? 1,12\n#???#?.??? 3,1,1\n????#?.?.????????? 1,1,2,1,4,3\n#?????#??#??.??????? 1,8,1,1,4\n..?#??##?? 1,3\n.#???.?##?##????? 1,10\n??#??#?..??#??.??#? 7,5,2\n??..??..#??? 1,1,1,1\n???.????##?#.? 2,7\n.?##???????.?#?.?.?# 2,3,3,1\n.?.??#??????#?#??? 1,1,1,3,6\n#?.???#?????#.#???. 2,4,2,2,1\n?#?#???.?#????#?? 4,6\n????.?????#?????#?? 1,2,2,9\n??.??#?#.???#??.?##? 1,5,2,1,2\n????#.?.???#??..? 1,6\n??.?.?###?#???.????? 1,1,6,1,2,1\n??#.###.#???. 3,3,1,2\n????#?..#?#???? 1,1,1,2,1\n.??#??#????????##?# 1,1,5,1,6\n#??##.??#???#?? 5,8\n???????#??? 3,4\n.??.#.??.??.???? 1,1,1,2,1\n??#??.?#?.?? 4,1,2\n.???????.???#?????.? 3,6\n???#????#????#??#??. 3,14\n????????..?????.? 3,1,2\n?????#?#?.#??? 1,4,1\n#???.??##.???? 4,2,1\n?.?#????#? 2,3\n?.?.???##???. 1,7\n...#####?.??##? 6,3\n?#???#?????? 1,3,2,1\n???.##?###? 1,7\n#?#???#????? 7,2\n.??#???.?#???.???# 5,3,4\n?#?#??#??#.?#???.#?? 1,5,1,2,1,1\n??????##??##??#??. 4,8,1,1\n??#????..??##???#??? 4,1,9\n?.??#?.?.? 2,1\n?#????#?.?? 7,2\n???????##?????? 4,4,2\n??##?.?#???.#?.????? 1,3,3,1,1,5\n.?.?????#????? 1,1,3,1\n?????.??#?????###? 5,1,2,1,3\n???#??.#??????.?. 1,4,1,5\n??#????????#.? 2,1,4\n?.??????#..? 3,3\n?????##..#.? 2,2,1\n.#?..????#####???#. 1,13\n.??.?????#?#?.#? 1,1,6,1\n??????????#??. 6,2\n???.?..??? 3,1,1\n??#???????#?????? 3,6,2\n?.???.????.??#? 1,2\n????.???????????? 2,8\n.#.??????. 1,5\n?????.???. 2,1,2\n??.??#???#..?###???. 1,5,1,6\n#????#.??##?.??# 3,1,3,3\n???#???.#?.?.?????.? 6,2,1,3,1,1\n.###.???.? 3,1\n???????..??#? 6,2\n????#??????#? 5,2,2\n????????.??#?? 2,3,1\n#?#.???.??? 3,1,2\n?###?###???.?? 8,2\n?#??.#..#?.?#???. 1,1,2,3\n?????.?#????? 5,1,1\n.?#??????.?.?.?? 3,1\n.#??##??.???#?#.. 7,3\n???#?.?????? 2,4\n???#.???.. 3,1\n?.???#??#.????# 1,1,1,1,2\n??????##.??#????#?? 7,1,2,5\n?????.?.?? 1,1,1\n#??#?????.????. 1,3,3,2,1\n?.???##????.??#?#.. 5,2,3,1\n?#.#?????? 1,1,1\n??????#?##?#?.?#?. 1,1,1,2,1,3\n??#????.##? 3,2\n??.?.#.??#? 2,1,1\n?????##?.?#??? 3,3,1,1\n???#.?#???? 2,3\n???????..?#??#??#??? 3,2,6,1,1\n.??#?#??.????#??#??# 7,1,7\n???#.?#?.# 2,2,1\n??.?##?#.??# 5,2\n?.????#?#.? 4,1\n????.???#.? 1,3\n?#????#??#???#? 1,1,2,2,3\n.?????#??#??#??. 1,10\n?#?#??#?????#?#?#??? 13,1,1,1\n?#??.?#?#.???? 1,1,3,1\n???#.???#?? 1,1,5\n#???????##???? 1,1,7\n?#.?????###? 1,1,6\n?..??.????# 1,3,1\n?.#??.????#? 3,1,3\n?.#?#??#??????? 1,1,4,1,2\n.???????..#.??????#. 4,1,1,1,2,1\n???#..?#..?.??##?# 1,1,2,1,5\n??????????.#. 1,1,3,1\n????..????????????# 1,1,1,3,1,2\n.#.??#???? 1,1,1\n??????????????????? 4,1,4,1,1\n??????????#??#?????? 4,8,1\n.???#?.??? 2,1,2\n???.???#???.?.??#? 2,6,4\n?.?.??????#?#?#? 8,2\n??#?.????? 1,4\n??#???#??????#???. 2,5,2,1\n?#???.#??? 2,2\n#??.##?####??#? 1,11\n#????##??.????.?##.? 4,4,1,1,3,1\n???...?#??#??? 2,6\n???????????? 1,1,3\n?#.????#??.#..?? 1,1,4,1,1\n.?.?????##??##???? 1,1,12\n????????..??## 1,5,3\n?????#?#..#??? 7,1,1\n.?##???.#?#.??#? 2,1,3,1\n.??##??#????#.???..? 8,2,1\n?#????.??.##???? 3,1,3\n#??#????#????? 5,4,1\n##?#?????#? 4,2\n???#??#??.. 2,3\n?#????#????.#.###? 2,5,1,3\n?.?????#?#??.????#?? 1,4,2,5,1\n#????#??.??? 2,2,1,1\n.?????#??.????.? 4,3,1,1,1\n?#..?#??.# 2,1,1\n#?.??#??.?##?? 1,4,5\n??????##??.? 1,1,4\n???..#?.????.? 1,2,2\n???#?.#?.?#??#..#? 5,2,3,1,2\n?.#?#????#?????????? 10,1\n??????#??.? 3,3\n????#?#??#??###?? 5,7\n?????.?.?.#?.? 3,1,1\n?????#?#####?# 3,9\n?#??.?..??. 3,1,1\n?#?????#?#??#.??? 4,6,3\n?????#?.??. 1,4,1\n????#?###???..? 10,1\n.???#??#?.??#?# 1,1,1,3,1\n#????#??#.? 1,6,1\n#????#?.#?#?.#.?? 3,1,4,1,2\n#.?.?.?#.??.???#? 1,1,2,1,5\n??????..?????#??.?. 1,1,1,4,1,1\n????..?..?????# 1,1,1,1,2\n??.#???.?#? 1,3,1\n????.??#?. 1,2\n?#??#??????.??? 8,1\n??????###??#.??.?? 1,6,2,1,1\n????..##??#?#??????? 2,11\n?.???##??????. 2,7\n.#??#?.?????? 2,1,4,1\n?.?#??#??##?#???#??# 1,8,8\n#????.#?????#??????? 1,1,1,7,1,1\n?...?#?.????##?? 1,1,7\n..???.???????#? 2,6\n#?#???#?????????? 5,5,1,2\n??.??????? 1,1,1\n..?.???.??? 1,2\n#.????.?#????###???? 1,2,2,7\n??.?..??????#???? 1,1,2,6\n.?#????##.#.??#???? 8,1,5\n#??##?.?#???# 6,3,1\n???#?????????????? 9,1,1,1\n?#????.???#??# 3,1,3,2\n????.??????????.? 1,1,2,1,3\n?..?#?????..?#?.??# 1,2,2,1,3,2\n??#???#?#??#??#??? 4,3,6\n.????#.???????? 2,1,1,1,1\n.??????.#?#.# 4,1,3,1\n.?#?#?#??#?????#? 1,6,1,1\n???.????#.????? 2,4,1\n.?.??#???? 1,1\n?.?#????#?##?#?? 3,7\n..???##??#.#.???? 7,1,1,1\n?.???#??????###??.#? 1,1,1,4,3,1\n????#???.???..# 2,1,1,1,1\n??????.?.#???. 4,2\n.??#??.?##.#??? 5,2,1,1\n?.?.???##?????#???.? 1,1,11,1\n??##??#?????.?????? 10,3\n.???#.??????????# 1,1,5,3\n??.#??##???##??##?? 10,3\n?#.???#??.? 1,5,1\n??????.?...??#??#?.. 3,7\n?.???????????. 2,1,2\n??????????..?###??. 5,3\n??????#?.?? 1,5\n.?##..#??? 3,2\n??#?..???#??? 3,1,2,1\n????????.#??## 1,1,2,2\n#??????#?..# 1,3,1,1\n??.#?.?????# 1,1,1,1\n???#?????.?. 5,1,1,1\n?????????#? 2,7\n?##?.##????? 3,2,1,2\n?#.????.?###? 2,2,4\n?.#?.?#???? 2,1,2\n??#???.???.??. 2,1,3,1\n.?#?#????? 1,1,2\n.???.???#?###?? 2,7\n?#?#??????????# 6,1,1,1,1\n??????.???? 1,2,1\n..??.?#???#.??#??#?. 2,5,2,3\n?????#?.???##??#?? 2,2,6,1\n???..??.??...#?#..?. 2,3\n#?.?#??#?? 1,2,2\n?????????.??#???.??# 2,5,1,1,1,2\n#????##?#?#?.?? 2,3,1,2,1\n#????????????#??? 1,2,11\n?????????..? 1,5,1\n???????..?????.#???? 1,4,1,1,3,1\n???.????????????#? 1,1,1,1,2,5\n??.????###?#? 1,8\n.?##???.??????# 5,4,1\n.????????.??.???? 2,2\n?#?#.????#??? 3,6\n???#??.#??#.?#?.?? 1,3,1,1,1,1\n??..?.??#? 1,1,1\n???..????#.?#? 1,1,3,1\n???#?????????.? 1,2,1,1,1\n?????.###?#?.???? 1,6\n??##???#####.??.?.? 11,1,1,1\n????.#?#??..??. 3,1,3,1\n???#????????????? 2,1,2,5,1\n?#????.?.#??? 1,1,1,4\n#?????#???#?#. 1,1,2,3\n????#????#??#???? 1,12,1\n..#.?#.??#?.?.#.??? 1,1,3,1,1,3\n???????##?# 1,2,4\n????????#????? 4,4\n#??...?#?.#.???? 1,1,2,1,4\n?#?.???.###?.#???? 3,1,3,2,1\n?#???????? 2,1,1\n.#???#?????###? 1,4,3\n???#?.??.?????#?. 4,6\n????##??#??#?##?. 1,3,1,4\n?.???#?##??#?? 6,1\n?????????.??????#?# 1,1,5,1,1,4\n??????#??##???.?# 1,10,1\n.?#...??.??.???? 1,1,1,4\n#?#.#?##?..#??#? 1,1,4,1,2\n.#??.????##?..?? 1,1,1,3,1\n??????#??#?? 7,1,1\n??##?#??.#?#. 5,3\n?...????.##??# 1,2,5\n.#?.???..? 1,1,1\n???.?..????#???. 3,5\n???????#???#??#??#?? 1,9,1\n??#?##???.#??.#.???? 4,1,1,1,1,3\n.?????..????##?? 1,7\n??????###??##?#????? 1,2,14\n???#???.#???.??? 1,4,2\n??.?#??????????? 1,11,1\n??.?.????..???##??.? 1,1,5\n#??????#??.??????. 2,5,1,3,1\n??#?.?.???#?##? 2,1,6\n.????..????? 2,2\n????##???..?##?..? 1,4,3\n..????.?.??????????? 1,2,1,6,3\n#??#?###??#????#. 4,6,3\n#?##?#???.????##???. 9,9\n.#?????.?..? 1,1,1,1\n???##??#??###?##?? 8,8\n??.????#??.?#..# 2,7,1,1\n??????#??????????#? 2,4,10\n??##?#?????##??.#?? 11,1,2\n??..?.#?#?? 1,1,5\n????###?#??.?#??.?. 6,4\n??.##????#?..? 1,2,5,1\n??????#??##??????. 8,2\n????##???.##??#???? 6,5,1\n???????##?.?..?????. 6,3\n#????##..?? 3,2,1\n??#??##??#?..? 1,5,2,1\n???#???.???#??? 1,3,5\n.??#.#???.?#?.#?.?? 3,4,3,2,1\n.???##...????? 5,1\n?#??.??#?.#???##.#?. 1,1,1,6,2\n.?#??#??#?#?##??# 4,9\n???#????.???.??#.?? 8,2,3,1\n.??#.?.?##.. 2,3\n????##?#?.? 1,5,1\n?.?.??????###? 1,2,7\n?#????????????? 3,1,4,2\n..#??#????????? 4,1\n???.?.??????#??#?? 1,1,2,1,5,1\n.???#??#?#????????#? 11,3\n.???#??.#??.? 3,2,1\n????#????#???#?# 1,4,1,3,1\n?####?#????.??##??? 10,1,5\n#???.??.?#. 1,1,2\n??####?????#? 7,1\n????????##?.#???.? 2,6,4\n?#????##.?????? 3,1,2,1,1\n??#?#??????.#? 6,1,1\n?????????.#.# 7,1,1\n??????????????? 6,5\n.?.?.##??? 1,3\n.##?.#??.???#? 3,1,5\n???#???#???????? 4,1,2,1\n..???????? 1,1\n???????????? 7,1\n..????.???????? 3,1,3\n???.???????#???##?? 1,2,1,2,4\n.?###?.???? 4,1,1\n?.?#?#??#?###???#??? 2,12,1\n????#??.?.?????.?? 2,1,1\n?????#???????#???? 1,6,4\n?.???.?#???? 2,4\n??###..????##???##?? 5,9\n??????????. 1,3,1\n#??????###?? 5,4\n#?#..?#??#?##??? 1,1,3,7\n??#?.?###?????##?. 3,5,4\n??#???????##.?##? 10,2\n#.??###?#? 1,5\n?...##??##?##??. 1,9\n.??#???#.???????? 6,2,1\n#??#?#??.#??#?##??. 8,9\n?..?.#???????#?? 1,1,3,4\n??.?#??#?.?.#??? 5,4\n?..???????#??##???? 1,1,5,3,2\n.?#?????.. 2,1\n???###..??? 4,1\n????#??????###???#?? 1,2,1,1,9\n??#????.????.#??#??? 5,3,4\n?#???#..?.??????.# 2,1,1,2,2,1\n??...??##?#???#?? 1,9\n???.#??.????#? 3,2\n?????...???.#???. 2,1,1,1\n???#???##???#??..?## 1,1,4,4,2\n??????#??..??. 2,2,1\n?????##?????????# 1,6,1,3\n.#.#.?#???.? 1,1,4\n?????.???.???? 1,1,3\n???.??#??.????#??? 1,3,1,8\n??##???????.?##??? 3,1,2,4\n???#???????.?#. 9,1\n????#.??????. 3,1,4\n.????.#?##??#. 1,1,7\n?.???????? 1,1,2\n.????#.?##?#?#???. 5,8,1\n?#??.??.?#?? 3,2,2\n?????????? 2,1,1\n#.??????##??????## 1,2,3,5\n?#??.?#?#?? 1,5\n.##???#?#?????#??? 8,1,4,1\n??.?????.??#?????# 2,5,4,2\n?..?.??.??#? 2,4\n???..??.???##? 1,1,6\n#??#?..???.???.#??. 5,1,1,2,1,1\n?????#?#??#?# 3,4\n#???.?..??##?# 1,1,1,6\n.#????.???#??? 5,1,3\n#.???#???? 1,1,4\n.?????..?????#? 2,1,1,1,1\n.#???#??.?#?. 1,3,2\n????.????#??? 1,2,4\n?##?#???###??..?##? 5,6,3\n??????#??#???. 1,1,1,5\n#???????????. 5,2\n#.??.????????.??? 1,2,7,1,1\n??#.??.?????###? 1,1,2,5\n.#?.?..#???????? 1,4\n?###?##.?? 4,2,1\n.????.?#?##.? 1,4\n?.##?.?..?? 2,1,1\n?#?.?#.???? 1,2,1\n.???##????????. 6,4,1\n.##???????##???#??#? 2,1,9\n#???????## 2,4\n#????#.#.?#? 6,1,2\n??#?#??#?? 3,2\n##.??.??.?.#?? 2,1,1,1\n?#????????#?##?#??#? 2,1,1,1,7\n?????#????????. 1,7,1,1\n??.???#???#?#? 5,4\n.????.#?####?#????? 1,1,11\n???.??.?????#????.?? 1,1,8,1,2\n??????.?.#?#????# 3,1,8\n#?.??????..# 2,2,1,1\n???#?????? 2,2\n?????#??.????##? 7,5\n.???????#??? 1,8\n?.???????.??? 5,1\n.????##???#???????? 1,5,3,3\n.?#???###?#???#? 1,8,2\n?##??#????#???#?.?? 3,5,2,1,1\n??#?#.???? 1,3,1\n?????????????? 1,3,2,4\n??#??.?????#??#? 3,9\n#.#????##?..? 1,2,5\n?#????#??????? 1,1,7,1\n.??#??#????###??? 8,3\n?.???#??#?? 1,3\n?#??.???#?????????? 4,6,4\n?.?.?#.?#???#??????# 1,1,2,8,1\n??#???????? 1,4\n.#????????. 3,1,1\n.#?#?#????????? 1,1,1,6,1\n???#???#?????? 3,1,1,2\n?.#??#???????#????.? 1,1,5,5,1\n.#????#.????# 4,1,1,1\n#.?.#?#?.??#?#?#? 1,1,4,7\n.?????.???. 1,2\n??.???#????#?#..??? 2,2,2,5,2\n.????.????##?? 2,6\n??#?.??####??. 3,5\n?#?#?????#?????# 7,4,1\n??.#????#?? 1,4,1\n?????##???#??.? 5,1,3,1\n????????.#??? 3,2,1,1\n???.???#?. 1,1,1\n#?.#?.?##. 2,1,3\n???#??.???#. 4,2\n?#?#????#.??#..????. 9,1,1,1,1\n?#??.??#??#? 2,1,3,2\n?##???#??????##.?.? 2,11\n????#?.?????. 5,4\n???#?.?????#???? 3,3,4\n????####??.??#????? 8,5\n???#??#??? 1,3,3\n???#?#????#??#??..# 14,1\n???..?.???? 1,2\n#...??????.?#??.? 1,5,3\n???#?#??????.??##?? 3,1,5,1,2,1\n?##??.?.?#? 3,1,1\n##?????#?#??????#.? 8,1,4\n.##???##??#?###??.?? 4,11,2\n###.???????.???? 3,1,2\n?...??????????#???? 1,5,3\n????.?.#??##???.? 4,1,2,1,1\n#??.?#?.#???. 2,3,3\n?#??#?#?..???????? 1,4,1,1,1,1\n.????.?#?#.?????.?# 3,3,1,1,2\n##?.???.#????#?#???? 2,2,1,1,8\n.?????##????#?.#.? 8,2,1\n?#??###???#??????#? 12,1\n.?..??.??????#??.#?. 1,7,2\n?#????#?...?#?? 1,3,1\n??????????????? 3,1,3\n??????.????##? 1,2,6\n.???.?##???? 1,3,1\n?####?.#????.#? 5,3,1\n?.#?#????????..# 1,3,4,2,1\n#?.?.????#?? 2,1,2,3\n??#???????#???##?# 10,5\n.???#?????.? 1,6\n?.#?.???##?????????? 1,2,6,7\n???????#?#??#? 1,1,1,7\n?#??#?#??..##???.. 8,4\n????????.#? 2,1,1\n#.#??..?.#???? 1,3,3,1\n#???.??#???? 2,1,4,1\n????.????? 3,1,3\n?????.##???.??? 1,2,2,1,1\n??#??.#?????#?? 3,2,3\n.??#???.??###??? 1,1,6\n?????.???.? 1,2\n?.?#?????#???. 8,1\n.???????#?#??????# 1,6,3\n????##?#????.. 1,4,2\n?.??.?.?????? 1,1,5\n?????.###.? 4,3,1\n???..??#.##? 1,3,2\n#.#??#??.?????#.?? 1,4,1,1,1,1\n.#?????.?##???.?# 2,3,4,1,1\n???#????.??????.??.? 4,1,1,1,2\n...???.?.#. 2,1\n???#?.##.???.????? 3,2,2,1,1\n??????#??.##???????. 4,9\n#?#????????? 5,4\n.#????##???.?? 1,7,2\n???#.?.?#. 1,1,1\n???#?##.??#??#??.##. 6,6,2\n???????#?#?#?###?#. 1,11\n????#.#??.? 2,1\n?.#??.?????#??????? 3,2,8\n?#.???????? 2,4,1\n??.?#??#??? 2,7\n.?????????#? 3,4,2\n?.???.???#.? 3,3\n.#?#??##??? 4,3\n?.?????????? 3,3\n?????.?.#????????? 1,1,1,1,5,1\n?#?.???????#?#???#? 2,3,3,2\n.?#?#?????.????..? 8,3\n.?#?#.?..???? 3,4\n?.?????.?.##.??.? 5,1,2,1\n??????#???.? 3,4,1\n#?.????.?####?? 2,1,1,4\n????#?????????#? 2,3,6\n?.#??#????##?????#? 1,2,1,2,4\n??..????##???? 2,8\n?##?####??# 8,1\n?.?#####?????#.?. 6,3\n###??#..##??.??#?. 6,3,2\n?????#??.???#? 2,4\n?.??????#?#?#?? 1,6\n????#?????? 5,1,1\n#??#?#.#?????#.???? 1,2,1,3,1,3\n??#?????##???.. 3,6\n???#??#?????? 4,2,1\n?.??###.??? 4,1\n???.???????.??? 3,3,2,1\n????????#?????#?.?? 4,2,1,1,1,1\n????.???????#?? 1,1,1,4\n##??....##??? 4,3\n.?#???#?????.?#???. 8,1,2,2\n?.?##?????.. 1,5,1\n##???#????? 2,4,2\n??.?.????##?????. 1,10\n?##???###??.?????#. 10,1,1\n???????#???? 3,1\n?.??..???#.? 1,1,2,1\n#????#.... 2,1\n?#?.?????? 3,1,2\n??.#?.??#?.. 1,1,4\n?.??.#???????#?? 1,7\n???#??#??#??#?? 4,2,2,3\n???..#?##? 1,4\n.???#??..??. 4,2\n?#?.????#???#? 2,1,2,2\n???????#.???#?#?. 4,1,2,1,1\n?????.??#??? 2,5\n??????.?####?? 3,6\n???##??????? 9,1\n????##?#?.??.#??.??? 1,7,1,1,1,1\n#????###??##?.?.?? 2,8,1\n???.??..?. 1,1,1\n.?#??#????#?#?#? 1,11\n?.???#.???????? 1,2,6\n?????##?.??#??## 8,3,2\n?.?????????? 4,3\n???.???#?##???????? 2,1,6,3\n..??????##?#????? 8,2,1\n.?.#??#???##..#??#? 1,9,2,1\n?.?#.??#?# 1,1,5\n.#.??#?#?#? 1,5\n.#??????.?# 1,2,2\n.?????????.???.# 1,4,1,3,1\n#?????##?#?????????? 1,1,8,1,1,2\n?##?#???.???????##? 7,10\n#.?.##.?#? 1,2,1\n?##??..???#? 4,2\n??#?#????# 6,2\n#?.##?#??? 1,6\n???#.?#???###.????# 2,1,7,5\n??????#?##??.? 3,7\n?#?#??#??????.. 3,1,1,2\n.??#??#?.?.??????? 1,5,1,3,1,1\n#??.#??.#??#??????? 3,3,1,5,2\n.##??????????????? 3,2,2,5\n??##??.#?####.. 4,6\n?.???###?.#..?? 6,1,1\n???????????? 1,1,7\n???#?#?#??????##??? 9,3,1\n??????.???. 5,3\n.????#??????##??? 6,8\n..?#??#???#?#?.??## 5,4,2\n?????#???###?.#?.??? 1,9,2,2\n#?.??#?#?? 2,3,1\n#?#???.???##? 3,3\n#????#???????.??#? 12,1,1\n#???.?????###?#? 1,2,2,5\n#?.?????#?##???##?? 1,1,11\n??#??#????#?# 1,1,1,6\n..#??.??#???? 3,1,1\n???##??????#?##?. 6,4\n.???????.#.??#?????? 4,1,1,8\n..??.????#?.?# 1,2,2,1\n.????#??.?#?.??##??. 5,1,1,4\n?#.??????? 2,1,2\n????#?##??#????? 9,2\n?????????#. 2,1,1\n?.?#????##????#? 1,9,1,1\n..?#??#??.???? 6,2\n?##??????.??????# 6,2,1,1\n????#??#??#?#?.. 5,7\n?#?#???.?###???????# 5,7,1,2\n??#?#??#???? 1,1,2,1\n?.?.?#???### 1,1,2,3\n?????.???????#?.??.? 2,1,9,2,1\n.??##???#.?.????#? 6,1,2,1\n??.?????????.??.. 2,4,1\n??#???#?##?? 4,5\n???#??####?.????? 10,1\n??????#????#??#? 1,10,1\n##?.????????# 2,3,1,3\n?#??.?.??###?.#?## 1,1,1,1,3,4\n???#?????##? 1,2,1,3\n?#???.?.##???.?????. 4,1,3,5\n#..?..?.?##?#?? 1,1,6\n?.??.?????..? 2,2\n???#??.?#??#? 5,2,3\n##??????#??? 3,3\n??#.?.??.#????#?#? 3,1,2,5\n?.?????????#???????? 10,2\n???.?#.?????????#. 2,1,10\n???#??##??????# 9,1,2\n??##?#?????###.? 8,3\n?##????.?.???#??. 2,2,1,4,1\n.?#?###???????????? 7,1,1,2\n#????#???#?#?.????# 1,1,5,2,1,1\n.??????.???????. 6,1,1,1,1\n??????.??#. 1,1,3\n??.??##??.? 1,2\n??????#???.?.??. 1,5,1,1\n???##.??#??? 4,1\n..???#??#? 4,2\n#????.#?.?????#???? 5,1,1,1,2,1\n?.??#???.#?.????. 4,2\n?.#.#?.?.??#??? 1,2,1,1,3\n?.???###??##?..???. 7,2,1,1\n?##?.????????? 2,3,3\n???????????????##??? 1,1,5,1,3,1\n?#.?????#????#??#??? 1,2,1,7,2\n###?.???#?#????????? 4,7,5\n.??#?????. 1,1,1\n..###??#??? 3,3\n???#???#?.#?.#??# 5,2,2,4\n??.???#.???????.. 4,3\n?#???.?????? 1,1\n??..??????? 1,3,1\n??#???????.??.?#? 7,1,2,2\n?????????.???#?. 3,1,1,3\n.????#.???##?? 5,6\n??????.??? 1,2,2\n?????????? 2,1,3\n?????.??#?? 2,4\n?.?.??#??????.? 1,4,3\n?#?#???????????# 12,1\n#?.?#????? 1,7\n????#?#?#????# 1,6,1,1\n...?#??????????##?# 8,4\n??????#??? 3,4\n??.????????????? 1,1,2,1,2\n?#??#?#??#.?#???? 7,2,3\n????..???#??#??. 1,2,1,6\n?????.??#?????.??. 1,5\n?#.????????? 1,1,1,3\n??##?.#?#??? 3,5"

case class Record(cfg: String, nums: List[Int])

def parse(input: String): List[Record] =
  input.linesIterator.map( line =>
    val (s"$cfg $nums") = line: @unchecked
    Record(cfg = cfg, nums = nums.split(",").map(_.toInt).toList)
  ).toList

val cache = mutable.HashMap[(String, List[Int]), Long]()

def scan(cfg: String, nums: List[Int]): Long =
  if cfg == "" then
    return if nums.isEmpty then return 1 else 0
  if nums.isEmpty then
    return if cfg.contains('#') then return 0 else 1

  val key = (cfg, nums)
  if cache.contains(key) then
    return cache(key)

  var result = 0L
  if ".?".contains(cfg(0)) then
    result += scan(cfg.drop(1), nums)

  if "#?".contains(cfg(0)) then
    val codeLength = cfg.length
    val firstCodeSequence = nums.head
    if firstCodeSequence <= codeLength && !cfg.slice(0, firstCodeSequence).contains('.') && (firstCodeSequence == codeLength || cfg(firstCodeSequence) != '#') then
      result += scan(cfg.drop(firstCodeSequence+1), nums.drop(1) )

  cache(key) = result
  result

def part_one(input: String) =
  parse(input).map( record =>
    scan(record.cfg, record.nums)
  ).sum

part_one(sampleInput)
part_one(puzzleInput)

def part_two(input: String)=
  parse(input).map(record =>
    val extendedCfg = List.fill(5)(record.cfg).mkString("?")
    val extendedNums = List.fill(5)(record.nums).flatten
    scan(extendedCfg, extendedNums)
  ).sum

part_two(sampleInput)
part_two(puzzleInput)
